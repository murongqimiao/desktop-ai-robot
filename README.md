# 桌面 AI 机器人

一个基于 Electron 的智能桌面 AI 机器人，具备表情动作、语音识别（ASR）和文本转语音（TTS）功能，支持与用户进行自然对话。

## 功能特性

### 核心功能

- ✅ **表情动作系统**
  - 透明无边框窗口，窗口大小与机器人脸部一致（300x200）
  - 可在桌面随意拖动，支持边缘吸附（拖动到屏幕边缘自动隐藏，保留 20px 可见）
  - 自动眨眼动画和眼睛瞳孔动画效果
  - 支持多种情绪表达：正常、开心、难过、思考、狡猾、说话
  - 根据 AI 回复中的表情包自动识别情绪并调整面部表情

- ✅ **离线中文语音识别（ASR）**
  - 基于 Vosk-Browser 的离线语音识别
  - 触摸窗口后自动激活，10秒无操作自动休眠
  - 支持中英文双语识别
  - 自动断句和句子完成检测
  - 流式识别结果，实时反馈

- ✅ **文本转语音（TTS）**
  - 支持 Edge TTS 和 Coqui TTS 引擎
  - 流式音频输出，边生成边播放
  - 自动清理特殊字符和表情包
  - 根据表情包提取情绪，影响机器人表情
  - 支持音色切换

- ✅ **AI 对话能力**
  - 集成 DeepSeek API，支持流式响应
  - 实时语音交互，语音输入 → AI 处理 → 语音输出
  - 流式文本处理，按标点符号拆分并立即转换为语音

## 安装依赖

### 前端依赖

```bash
npm install
```

### Python 后端依赖

```bash
# 创建虚拟环境（如果还没有）
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # macOS/Linux
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 配置文件

在根目录创建 `conf` 目录，并添加 `token.json` 文件：

```json
{
    "deepseek_token": "你的 DeepSeek API Token"
}
```

## ASR 语音识别功能设置

本项目集成了基于 Vosk-Browser 的离线中文语音识别功能。

### 快速开始

1. **下载模型文件**（首次使用需要）：
   ```bash
   ./download-model.sh
   ```
   或手动下载模型到 `models/` 目录（详见 [ASR_SETUP.md](./ASR_SETUP.md)）

2. **功能说明**：
   - 触摸/点击窗口后，ASR 会在 10 秒内自动激活
   - 激活后如果 10 秒内没有新的交互，会自动进入休眠状态
   - 识别结果会实时显示，并触发 AI 对话流程

详细设置说明请参考 [ASR_SETUP.md](./ASR_SETUP.md)

## 运行项目

### 开发模式

```bash
npm start
```

这会同时启动：
- ASR 服务器（端口 8765）
- TTS 服务器（端口 8766）
- Electron 应用

### 单独启动服务

```bash
# ASR 服务器
venv/bin/python python/start_asr.py

# TTS 服务器
venv/bin/python python/start_tts.py
```

## 项目结构

```
desktop-ai-robot/
├── python/                    # Python 后端服务
│   ├── asr/                   # ASR 语音识别模块
│   │   ├── server.py          # ASR WebSocket 服务器
│   │   ├── model_manager.py   # VOSK 模型管理
│   │   ├── sentence_manager.py # 句子管理和断句逻辑
│   │   ├── result_merger.py   # 中英文识别结果合并
│   │   └── ai_client.py       # DeepSeek API 客户端
│   ├── tts/                   # TTS 文本转语音模块
│   │   ├── server.py          # TTS WebSocket 服务器
│   │   ├── engine_manager.py  # TTS 引擎管理（Edge TTS / Coqui TTS）
│   │   ├── synthesizer.py     # 文本转语音合成器
│   │   └── text_processor.py # 文本处理（清理、情绪提取）
│   ├── common/                # 公共工具模块
│   │   ├── config.py          # 配置管理
│   │   └── logger.py          # 日志配置
│   ├── start_asr.py           # ASR 服务器启动脚本
│   └── start_tts.py            # TTS 服务器启动脚本
├── scripts/                   # 前端 JavaScript 脚本
│   ├── client/                # 客户端管理器
│   │   ├── asr-manager.js     # ASR 语音识别管理器
│   │   └── tts-manager.js     # TTS 文本转语音管理器
│   └── robot/                 # 机器人控制脚本
│       ├── face.js            # 面部动画控制
│       ├── hear.js            # 听觉控制（ASR）
│       └── speak.js           # 语音控制（TTS）
├── models/                    # 语音模型文件
│   └── vosk-model-small-cn-0.22/  # VOSK 中文模型
├── conf/                      # 配置文件
│   └── token.json             # API Token 配置（DeepSeek）
├── main.js                    # Electron 主进程
├── preload.js                 # Electron 预加载脚本
├── index.html                 # 主界面 HTML
├── package.json               # Node.js 项目配置
├── requirements.txt           # Python 依赖
└── README.md                  # 项目说明文档
```

## 使用说明

1. **启动应用**：运行 `npm start` 启动所有服务
2. **交互方式**：
   - 触摸/点击窗口激活语音识别
   - 说话后，机器人会识别语音并调用 AI 生成回复
   - AI 回复会通过 TTS 转换为语音播放
   - 机器人会根据回复中的表情包自动调整情绪和表情
3. **窗口操作**：
   - 拖动窗口到任意位置
   - 拖动到屏幕边缘会自动隐藏，保留 20px 可见区域
   - 关闭窗口即可退出应用

## 技术栈

### 前端
- **Electron**: 桌面应用框架
- **JavaScript/ES6**: 前端逻辑
- **WebSocket**: 与 Python 服务通信
- **Vosk-Browser**: 离线语音识别（WebAssembly）

### 后端（Python）
- **VOSK**: 离线语音识别引擎
- **Edge TTS**: 文本转语音服务（推荐）
- **Coqui TTS**: 备选 TTS 引擎
- **WebSockets**: 异步 WebSocket 服务器
- **httpx**: HTTP 客户端（用于 DeepSeek API）

## Future - 长期记忆系统

我们计划实现一个完整的长期记忆系统，让机器人能够记住与用户的对话历史，并根据记忆调整行为和情绪。

### 对话上下文管理

- **DialogId 机制**：为每个对话周期分配唯一的 `dialogId`，确保同一周期内的对话保持上下文连贯性
- **对话会话管理**：自动检测对话的开始和结束，合理划分对话周期

### 向量存储系统

- **本地向量数据库**：使用向量数据库（如 Chroma、FAISS 或 Qdrant）存储对话内容的向量表示
- **语义检索**：基于向量相似度进行语义检索，快速找到相关的历史对话
- **对话嵌入**：将每次对话转换为向量嵌入，支持高效的相似度搜索

### System 级别 AI 控制

- **系统级 AI 代理**：独立的系统级 AI，负责分析对话历史、提取关键信息、管理长期记忆
- **情绪状态管理**：系统 AI 根据对话历史和记忆内容，动态调整机器人的系统级情绪状态
- **行为策略**：基于长期记忆和当前情绪，决定机器人的响应策略和行为模式

### 关系型存储与记忆提取

- **关系型数据库**：使用 SQLite 或 PostgreSQL 存储结构化的对话记录和元数据
- **记忆提取机制**：每次对话时，从关系型存储中提取相关的历史记忆
- **Assistant 角色参与**：提取的记忆以 `assistant` 角色的形式参与到对话中，作为上下文信息提供给 AI

### 记忆压缩与优化

- **定期压缩**：按照自然时间周期（如每天、每周）对关系型存储进行压缩处理
- **关键信息提取**：压缩过程中提取对话的关键信息和主题，保留重要记忆
- **情绪状态更新**：压缩处理后，根据提取的关键信息更新机器人的系统级情绪状态
- **存储优化**：删除冗余信息，优化存储空间，保持记忆系统的效率

### 系统架构设计

```
┌─────────────────────────────────────────────────────────┐
│                   对话流程                                │
│  User Input → ASR → AI (with context) → TTS → Response  │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│              长期记忆系统                                  │
│                                                          │
│  ┌──────────────┐    ┌──────────────┐                  │
│  │  DialogId    │───▶│  对话上下文   │                  │
│  │  管理模块     │    │  管理模块     │                  │
│  └──────────────┘    └──────────────┘                  │
│         │                    │                          │
│         ▼                    ▼                          │
│  ┌──────────────┐    ┌──────────────┐                  │
│  │  向量存储     │    │  关系型存储   │                  │
│  │  (语义检索)   │    │  (结构化数据) │                  │
│  └──────────────┘    └──────────────┘                  │
│         │                    │                          │
│         └──────────┬─────────┘                          │
│                    ▼                                    │
│         ┌──────────────────────┐                        │
│         │  System AI 控制模块   │                        │
│         │  - 记忆分析          │                        │
│         │  - 情绪状态管理      │                        │
│         │  - 行为策略决策      │                        │
│         └──────────────────────┘                        │
│                    │                                    │
│                    ▼                                    │
│         ┌──────────────────────┐                        │
│         │  记忆压缩与优化模块   │                        │
│         │  - 定期压缩          │                        │
│         │  - 关键信息提取      │                        │
│         │  - 情绪状态更新      │                        │
│         └──────────────────────┘                        │
└─────────────────────────────────────────────────────────┘
```

### 实现计划

1. **Phase 1: 对话上下文管理**
   - 实现 DialogId 生成和管理
   - 对话周期检测和划分
   - 上下文信息传递机制

2. **Phase 2: 向量存储基础**
   - 集成向量数据库
   - 实现对话内容的向量化
   - 基础语义检索功能

3. **Phase 3: 关系型存储**
   - 设计数据库 schema
   - 实现对话记录的存储和检索
   - 记忆提取和上下文注入

4. **Phase 4: System AI 控制**
   - 实现系统级 AI 代理
   - 情绪状态管理机制
   - 行为策略决策系统

5. **Phase 5: 记忆压缩与优化**
   - 实现定期压缩任务
   - 关键信息提取算法
   - 情绪状态自动更新

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License
