<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robot Face</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      width: 200px;
      height: 133px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      overflow: hidden; /* 隐藏溢出内容 */
      -webkit-app-region: drag; /* 使窗口可拖动 */
      app-region: drag;
      background: transparent;
      margin: 0;
      padding: 0;
    }
    
    /* 窗口内容容器 */
    .window-container {
      width: 200px;
      height: 133px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      position: relative;
      border-radius: 10px;
      transform-origin: left top;
      transition: height 0.3s ease-out;
      overflow: hidden;
      -webkit-app-region: drag;
      app-region: drag;
    }
    
    /* 展开状态下的容器 */
    .window-container.expanded {
      height: 550px;
    }
    
    .window-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 200px;
      height: 100%; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) no-repeat left top;
      border-radius: 10px;
      -webkit-app-region: drag; /* 确保背景也可以拖动 */
      z-index: 0;
    }
    
    /* 确保内容在背景之上 */
    .window-container > * {
      position: relative;
      z-index: 1;
    }

    /* 脸部轮廓 - 高宽比 2:3 (高度:宽度 = 2:3) */
    .face {
      width: 200px;
      height: 133px; /* 300 * 2/3 = 200 */
      /* background: linear-gradient(145deg, #e0e0e0, #ffffff); */
      border-radius: 10px;
      position: relative;
      flex-shrink: 0; /* 不允许缩小 */
      box-shadow: 
        0 13px 40px rgba(0, 0, 0, 0.3),
        inset 0 -7px 13px rgba(0, 0, 0, 0.1),
        inset 0 7px 13px rgba(255, 255, 255, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.3);
      perspective: 200px;
      transform-style: preserve-3d;
      -webkit-app-region: no-drag; /* 允许面部区域点击，不拖动 */
      app-region: no-drag;
    }

    /* 眼睛容器 - 外层 */
    .eye {
      width: 53px;
      height: 53px;
      background: linear-gradient(145deg, #ffffff, #e0e0e0);
      border-radius: 11px;
      position: absolute;
      top: 50%;
      transform: translateY(-50%) translateZ(7px);
      transform-style: preserve-3d;
      transform-origin: center center;
      z-index: 10;
      box-shadow: 
        inset 0 3px 10px rgba(0, 0, 0, 0.2),
        0 3px 10px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: top 0.4s ease-out, left 0.4s ease-out, right 0.4s ease-out, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-app-region: drag; /* 允许面部区域点击，不拖动 */
      app-region: drag;
    }

    /* 3D变换 - 向下看（悲伤，倒梯形效果） */
    .eye.face-down {
      top: 70%;
      transform: translateY(-50%) translateZ(7px) rotateX(-30deg);
    }

    /* 3D变换 - 向上看 */
    .eye.face-up {
      top: 30%;
      transform: translateY(-50%) translateZ(7px) rotateX(30deg);
    }

    /* 3D变换 - 向左看 */
    .eye.face-left.left {
      left: 27px;
      transform: translateY(-50%) translateZ(7px) rotateY(-25deg);
    }

    .eye.face-left.right {
      right: 53px;
      transform: translateY(-50%) translateZ(7px) rotateY(-25deg);
    }

    /* 3D变换 - 向右看 */
    .eye.face-right.left {
      left: 53px;
      transform: translateY(-50%) translateZ(7px) rotateY(25deg);
    }

    .eye.face-right.right {
      right: 27px;
      transform: translateY(-50%) translateZ(7px) rotateY(25deg);
    }

    /* 3D变换 - 正常（正面） */
    .eye.face-normal {
      top: 50%;
      transform: translateY(-50%) translateZ(7px) rotateX(0deg) rotateY(0deg);
    }

    /* 眼睛位置移动 */
    .eye.position-up {
      top: 30%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-down {
      top: 70%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-center {
      top: 50%;
      transform: translateY(-50%) translateZ(7px);
    }

    /* 左移位置 - 两个眼睛都向左移动 */
    .eye.position-left {
      top: 50%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-left.left {
      left: 27px; /* 向左移动 */
    }

    .eye.position-left.right {
      right: 53px; /* 向左移动（right值增大表示向左） */
    }

    /* 右移位置 - 两个眼睛都向右移动 */
    .eye.position-right {
      top: 50%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-right.left {
      left: 53px; /* 向右移动 */
    }

    .eye.position-right.right {
      right: 27px; /* 向右移动（right值减小表示向右） */
    }

    /* 左上位置 - 两个眼睛都向左上移动 */
    .eye.position-up-left {
      top: 30%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-up-left.left {
      left: 27px; /* 向左移动 */
    }

    .eye.position-up-left.right {
      right: 53px; /* 向左移动（right值增大表示向左） */
    }

    /* 右上位置 - 两个眼睛都向右上移动 */
    .eye.position-up-right {
      top: 30%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-up-right.left {
      left: 53px; /* 向右移动 */
    }

    .eye.position-up-right.right {
      right: 27px; /* 向右移动（right值减小表示向右） */
    }

    /* 左下位置 - 两个眼睛都向左下移动 */
    .eye.position-down-left {
      top: 70%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-down-left.left {
      left: 27px; /* 向左移动 */
    }

    .eye.position-down-left.right {
      right: 53px; /* 向左移动（right值增大表示向左） */
    }

    /* 右下位置 - 两个眼睛都向右下移动 */
    .eye.position-down-right {
      top: 70%;
      transform: translateY(-50%) translateZ(7px);
    }

    .eye.position-down-right.left {
      left: 53px; /* 向右移动 */
    }

    .eye.position-down-right.right {
      right: 27px; /* 向右移动（right值减小表示向右） */
    }

    /* 眨眼动画 - 通过瞳孔缩放实现 */
    @keyframes blink {
      0% {
        transform: translate(-50%, -50%) translateZ(3px) scaleY(1);
        opacity: 1;
      }
      30% {
        transform: translate(-50%, -50%) translateZ(3px) scaleY(0.1);
        opacity: 0.8;
      }
      50% {
        transform: translate(-50%, -50%) translateZ(3px) scaleY(0);
        opacity: 0;
      }
      70% {
        transform: translate(-50%, -50%) translateZ(3px) scaleY(0.1);
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) translateZ(3px) scaleY(1);
        opacity: 1;
      }
    }

    /* 眨眼状态 */
    .pupil.blinking {
      animation: blink 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 左眼位置 */
    .eye.left {
      left: 40px;
    }

    /* 右眼位置 */
    .eye.right {
      right: 40px;
    }

    /* 瞳孔 - 内层 */
    .pupil {
      width: 21px;
      height: 21px;
      background: linear-gradient(145deg, #4a5568, #1a202c);
      border-radius: 5px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateZ(3px);
      transform-origin: center;
      z-index: 1;
      box-shadow: 
        inset 0 1px 3px rgba(0, 0, 0, 0.5),
        0 1px 7px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease-out;
    }

    /* 眼睛移动动画 */
    .pupil.look-left {
      transform: translate(-70%, -50%) translateZ(3px);
    }

    .pupil.look-right {
      transform: translate(-30%, -50%) translateZ(3px);
    }

    .pupil.look-up {
      transform: translate(-50%, -70%) translateZ(3px);
    }

    .pupil.look-down {
      transform: translate(-50%, -30%) translateZ(3px);
    }

    .pupil.look-up-left {
      transform: translate(-70%, -70%) translateZ(3px);
    }

    .pupil.look-up-right {
      transform: translate(-30%, -70%) translateZ(3px);
    }

    .pupil.look-down-left {
      transform: translate(-70%, -30%) translateZ(3px);
    }

    .pupil.look-down-right {
      transform: translate(-30%, -30%) translateZ(3px);
    }

    .pupil.look-center {
      transform: translate(-50%, -50%) translateZ(3px);
    }

    /* 转圈思考动画 */
    @keyframes think {
      0% {
        transform: translate(-50%, -50%) translateZ(3px) rotate(0deg) translateX(13px) rotate(0deg);
      }
      100% {
        transform: translate(-50%, -50%) translateZ(3px) rotate(360deg) translateX(13px) rotate(-360deg);
      }
    }

    .pupil.thinking {
      animation: think 2s linear infinite;
    }

    /* 瞳孔高光效果 */
    .pupil::after {
      content: '';
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 1px;
      position: absolute;
      top: 20%;
      left: 25%;
    }

    /* 控制按钮区域 - 隐藏 */
    .controls {
      display: none;
    }

    /* 嘴巴容器 */
    .mouth {
      position: absolute;
      bottom: 27px;
      left: 50%;
      transform: translateX(-50%) translateZ(3px);
      width: 40px;
      height: 13px;
      z-index: 5;
      transition: all 0.4s ease-out;
    }

    /* 嘴巴 - 横线（普通情绪） */
    .mouth.line {
      height: 2px;
      background: white;
      border-radius: 1px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* 嘴巴 - 圆圈（狡黠） */
    .mouth.circle {
      width: 13px;
      height: 13px;
      border: 2px solid white;
      border-radius: 50%;
      background: transparent;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* 嘴巴 - 向上弧线（高兴） */
    .mouth.arc-up {
      height: 20px;
      width: 33px;
      border: 2px solid white;
      border-top: none;
      border-radius: 0 0 33px 33px;
      background: transparent;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* 嘴巴 - 向下弧线（悲伤） */
    .mouth.arc-down {
      height: 20px;
      width: 33px;
      border: 2px solid white;
      border-bottom: none;
      border-radius: 33px 33px 0 0;
      background: transparent;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* 嘴巴 - 矩形（带圆角，说话时的初始状态） */
    .mouth.rectangle {
      width: 27px;
      height: 13px;
      border: 2px solid white;
      border-radius: 7px;
      background: transparent;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* 说话动画 - 从矩形到横线反复变化 */
    @keyframes speaking {
      0%, 100% {
        width: 27px;
        height: 13px;
        border-radius: 7px;
        border: 2px solid white;
        background: transparent;
      }
      50% {
        width: 40px;
        height: 2px;
        border-radius: 1px;
        border: none;
        background: white;
      }
    }

    /* 说话状态 */
    .mouth.speaking {
      width: 27px;
      height: 13px;
      border: 2px solid white;
      border-radius: 7px;
      background: transparent;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      animation: speaking 0.5s ease-in-out infinite;
    }

    /* 对话历史记录容器 */
    .chat-history {
      width: 100%;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px 8px;
      display: none; /* 默认隐藏，展开时显示 */
      -webkit-app-region: no-drag;
      app-region: no-drag;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
      min-height: 0; /* 允许 flex 子元素缩小 */
    }
    
    /* 展开状态下限制对话历史的最大高度 */
    .window-container.expanded .chat-history {
      max-height: calc(550px - 133px - 50px); /* 展开时：总高度 - 脸部高度 - 输入框高度 */
    }

    .chat-history::-webkit-scrollbar {
      width: 4px;
    }

    .chat-history::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-history::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
    }

    .chat-history::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* 展开状态显示对话历史 */
    .window-container.expanded .chat-history {
      display: block;
    }

    /* 对话消息项 */
    .chat-message {
      margin-bottom: 12px;
      display: flex;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 用户消息（左侧） */
    .chat-message.user {
      justify-content: flex-start;
    }

    .chat-message.user .message-bubble {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border-radius: 12px 12px 12px 4px;
      max-width: 85%;
      word-wrap: break-word;
    }

    /* AI 消息（右侧） */
    .chat-message.ai {
      justify-content: flex-end;
    }

    .chat-message.ai .message-bubble {
      background: rgba(255, 255, 255, 0.7);
      color: #333;
      border-radius: 12px 12px 4px 12px;
      max-width: 85%;
      word-wrap: break-word;
    }

    /* 消息气泡 */
    .message-bubble {
      padding: 8px 12px;
      font-size: 12px;
      line-height: 1.4;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 空状态提示 */
    .chat-history-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      text-align: center;
      padding: 20px;
    }

    /* 输入框容器 */
    .chat-input-container {
      width: 100%;
      padding: 8px;
      display: none; /* 默认隐藏，展开时显示 */
      -webkit-app-region: no-drag;
      app-region: no-drag;
      background: rgba(255, 255, 255, 0.1);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* 展开状态显示输入框 */
    .window-container.expanded .chat-input-container {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* 输入框 */
    .chat-input {
      flex: 1;
      padding: 8px 12px;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      outline: none;
      transition: all 0.2s ease;
    }

    .chat-input:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
    }

    .chat-input::placeholder {
      color: rgba(0, 0, 0, 0.4);
    }

    /* 提交按钮 */
    .chat-submit-btn {
      padding: 8px 16px;
      font-size: 12px;
      border: none;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-weight: 500;
    }

    .chat-submit-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .chat-submit-btn:active {
      transform: translateY(0);
    }

    .chat-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <!-- 窗口内容容器 -->
  <div class="window-container" id="windowContainer">
    <!-- 脸部轮廓 -->
    <div class="face">
    <!-- 左眼 - 外层div -->
    <div class="eye left">
      <!-- 瞳孔 - 内层div -->
      <div class="pupil"></div>
    </div>
    <!-- 右眼 - 外层div -->
    <div class="eye right">
      <!-- 瞳孔 - 内层div -->
      <div class="pupil"></div>
    </div>
    <!-- 嘴巴 -->
    <div class="mouth line"></div>
    </div>

    <!-- 对话历史记录 -->
    <div class="chat-history" id="chatHistory">
      <div class="chat-history-empty">暂无对话记录</div>
    </div>

    <!-- 输入框容器 -->
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chatInput" placeholder="输入消息..." />
      <button class="chat-submit-btn" id="chatSubmitBtn">发送</button>
    </div>
  </div>

  <script type="module">
    // 渲染进程错误捕获
    window.addEventListener('error', (event) => {
      console.error('全局错误捕获:', event.error);
      const errorInfo = {
        message: event.error?.message || event.message,
        stack: event.error?.stack || 'No stack trace',
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno
      };
      console.error('错误详情:', errorInfo);
      
      // 如果 electronAPI 可用，尝试发送错误信息到主进程
      if (window.electronAPI && window.electronAPI.reportError) {
        window.electronAPI.reportError('renderer-error', errorInfo);
      }
    });

    // 捕获未处理的 Promise 拒绝
    window.addEventListener('unhandledrejection', (event) => {
      console.error('未处理的 Promise 拒绝:', event.reason);
      const errorInfo = {
        reason: event.reason instanceof Error ? {
          message: event.reason.message,
          stack: event.reason.stack,
          name: event.reason.name
        } : event.reason
      };
      
      if (window.electronAPI && window.electronAPI.reportError) {
        window.electronAPI.reportError('unhandledrejection', errorInfo);
      }
    });

    // 导入模块
    import { FaceController } from './scripts/robot/face.js';
    import { HearController } from './scripts/robot/hear.js';
    import { SpeakController } from './scripts/robot/speak.js';

    // 初始化面部控制器
    const faceController = new FaceController();
    
    // 初始化随机情绪
    const emotions = ['normal', 'happy', 'sad', 'thinking', 'cunning'];
    const randomChoice = (array) => array[Math.floor(Math.random() * array.length)];
    faceController.setEmotion(randomChoice(emotions));

    // 初始化语音识别控制器
    const hearController = new HearController(faceController);
    
    // 初始化文本转语音控制器
    const speakController = new SpeakController(faceController);

    // 设置 AI 流式响应回调（连接 hear 和 speak）
    let currentAIResponse = ''; // 当前正在接收的 AI 响应
    hearController.setAIResponseStreamCallback((event, data) => {
      if (event === 'start') {
        console.log('AI 流式响应开始 - 用户输入:', data.user_input);
        // 添加用户消息到对话历史
        if (data.user_input) {
          addUserMessage(data.user_input);
        }
        // 重置当前 AI 响应
        currentAIResponse = '';
        // 清空状态，准备接收新的流式响应
        speakController.clear();
      } else if (event === 'chunk') {
        // 接收到流式片段，实时添加到文本
        if (data.chunk && data.chunk.trim()) {
          speakController.addText(data.chunk);
          // 累加当前 AI 响应
          currentAIResponse += data.chunk;
          
          // 实时更新最后一条 AI 消息（如果存在）
          const lastMessage = conversationHistory[conversationHistory.length - 1];
          if (lastMessage && lastMessage.type === 'ai') {
            lastMessage.text = currentAIResponse;
            updateChatHistory();
          } else if (currentAIResponse.trim()) {
            // 如果还没有 AI 消息，创建一条
            conversationHistory.push({ type: 'ai', text: currentAIResponse, timestamp: Date.now() });
            updateChatHistory();
          }
        }
      } else if (event === 'end') {
        console.log('AI 流式响应结束');
        if (data.error) {
          console.error('AI 响应错误:', data.error);
          // 如果有错误，移除不完整的 AI 消息
          const lastMessage = conversationHistory[conversationHistory.length - 1];
          if (lastMessage && lastMessage.type === 'ai' && !lastMessage.text.trim()) {
            conversationHistory.pop();
            updateChatHistory();
          }
        } else if (data.full_text) {
          console.log('完整响应:', data.full_text);
          // 确保最后一条 AI 消息是完整的
          const lastMessage = conversationHistory[conversationHistory.length - 1];
          if (lastMessage && lastMessage.type === 'ai') {
            lastMessage.text = data.full_text;
          } else {
            addAIMessage(data.full_text);
          }
          updateChatHistory();
        }
        // 重置当前 AI 响应
        currentAIResponse = '';
        // 标记结束，处理剩余文本
        speakController.markEnd();
      }
    });

    // 保留完整响应回调作为备用（兼容旧版本）
    hearController.setAIResponseCallback(async (userInput, aiResponse) => {
      console.log('用户输入:', userInput);
      console.log('AI 回复:', aiResponse);
      
      // 添加用户消息到对话历史
      if (userInput) {
        addUserMessage(userInput);
      }
      
      if (aiResponse && aiResponse.trim()) {
        // 添加 AI 消息到对话历史
        addAIMessage(aiResponse);
        
        // 使用 speak 控制器播放 AI 回复（非流式）
        speakController.clear();
        speakController.addText(aiResponse);
        speakController.markEnd();
      }
    });

    // 设置触摸检测
    hearController.setupTouchDetection();

    // 对话历史记录管理
    const chatHistory = document.getElementById('chatHistory');
    const chatHistoryEmpty = chatHistory.querySelector('.chat-history-empty');
    let conversationHistory = []; // 存储对话历史

    /**
     * 添加用户消息到对话历史
     */
    function addUserMessage(text) {
      if (!text || !text.trim()) return;
      
      conversationHistory.push({ type: 'user', text: text.trim(), timestamp: Date.now() });
      updateChatHistory();
    }

    /**
     * 添加 AI 消息到对话历史
     */
    function addAIMessage(text) {
      if (!text || !text.trim()) return;
      
      // 检查最后一条是否是 AI 消息，如果是则追加，否则新建
      const lastMessage = conversationHistory[conversationHistory.length - 1];
      if (lastMessage && lastMessage.type === 'ai') {
        lastMessage.text += text;
      } else {
        conversationHistory.push({ type: 'ai', text: text.trim(), timestamp: Date.now() });
      }
      updateChatHistory();
    }

    /**
     * 更新对话历史显示
     */
    function updateChatHistory() {
      // 清空容器
      chatHistory.innerHTML = '';
      
      if (conversationHistory.length === 0) {
        chatHistory.appendChild(chatHistoryEmpty.cloneNode(true));
        return;
      }

      // 渲染所有消息
      conversationHistory.forEach((msg) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.type}`;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        bubbleDiv.textContent = msg.text;
        
        messageDiv.appendChild(bubbleDiv);
        chatHistory.appendChild(messageDiv);
      });

      // 滚动到底部
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // 双击切换窗口高度
    let clickTimer = null;
    let isWindowExpanded = false; // 跟踪窗口展开状态
    let isResizing = false; // 防止重复调整
    const faceElement = document.querySelector('.face');
    const windowContainer = document.getElementById('windowContainer');
    
    if (faceElement && windowContainer) {
      faceElement.addEventListener('dblclick', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // 防止重复调整
        if (isResizing) {
          return;
        }
        
        // 清除可能存在的单击定时器
        if (clickTimer) {
          clearTimeout(clickTimer);
          clickTimer = null;
        }
        
        // 切换窗口高度
        if (window.electronAPI && window.electronAPI.toggleWindowHeight) {
          isResizing = true;
          
          // 先切换容器的 expanded 类（立即更新 UI）
          isWindowExpanded = !isWindowExpanded;
          if (isWindowExpanded) {
            windowContainer.classList.add('expanded');
          } else {
            windowContainer.classList.remove('expanded');
          }
          
          // 延迟调用窗口大小切换，给 UI 一些时间渲染
          setTimeout(() => {
            window.electronAPI.toggleWindowHeight();
            console.log(`窗口高度切换: ${isWindowExpanded ? '展开' : '折叠'}`);
            
            // 恢复调整标志
            setTimeout(() => {
              isResizing = false;
            }, 300); // 300ms 后允许再次调整
          }, 50); // 50ms 延迟
        } else {
          console.warn('electronAPI.toggleWindowHeight 不可用');
        }
      });
      
      // 单击事件（延迟处理，以区分双击）
      faceElement.addEventListener('click', (e) => {
        // 清除之前的定时器
        if (clickTimer) {
          clearTimeout(clickTimer);
        }
        
        // 延迟执行，如果是双击，这个定时器会被清除
        clickTimer = setTimeout(() => {
          clickTimer = null;
          // 单击事件已经由 setupTouchDetection 处理，这里不需要额外处理
        }, 300); // 300ms 内如果有双击，会清除这个定时器
      });
    }

    // 输入框提交功能
    const chatInput = document.getElementById('chatInput');
    const chatSubmitBtn = document.getElementById('chatSubmitBtn');
    let isSubmitting = false; // 防止重复提交

    /**
     * 通过文本输入发送消息给 AI
     */
    async function sendTextMessage(text) {
      if (!text || !text.trim() || isSubmitting) {
        return;
      }

      const userInput = text.trim();
      isSubmitting = true;
      chatSubmitBtn.disabled = true;
      chatInput.disabled = true;

      try {
        // 获取 ASR 管理器
        const asrManager = hearController.getASRManager();
        
        if (!asrManager) {
          // 如果 ASR 管理器还没初始化，先初始化
          await hearController.init();
        }

        const manager = hearController.getASRManager();
        
        if (!manager || !manager.websocket || manager.websocket.readyState !== WebSocket.OPEN) {
          // 如果 WebSocket 未连接，先连接
          await manager.connectWebSocket();
        }

        // 通过 WebSocket 发送文本消息
        if (manager.websocket && manager.websocket.readyState === WebSocket.OPEN) {
          manager.websocket.send(JSON.stringify({
            type: 'text_input',
            text: userInput
          }));
          console.log('已发送文本消息:', userInput);
          
          // 清空输入框
          chatInput.value = '';
        } else {
          console.error('WebSocket 未连接，无法发送消息');
          alert('连接未就绪，请稍后再试');
        }
      } catch (error) {
        console.error('发送文本消息失败:', error);
        alert('发送消息失败: ' + error.message);
      } finally {
        isSubmitting = false;
        chatSubmitBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    }

    // 提交按钮点击事件
    if (chatSubmitBtn) {
      chatSubmitBtn.addEventListener('click', () => {
        const text = chatInput.value;
        sendTextMessage(text);
      });
    }

    // 输入框回车事件
    if (chatInput) {
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const text = chatInput.value;
          sendTextMessage(text);
        }
      });
    }

    // 页面加载完成后延迟初始化（不阻塞页面加载）
    window.addEventListener('load', async () => {
      setTimeout(async () => {
        // 初始化 ASR
        await hearController.init();
        
        // 初始化 TTS（延迟加载）
        await speakController.init();
      }, 2000); // 2秒后初始化，确保页面完全加载
    });
  </script>
</body>
</html>

